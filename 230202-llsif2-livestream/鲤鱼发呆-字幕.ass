[Script Info]
; Script generated by Aegisub 9569-cibuilds-c7145a3f2
; http://www.aegisub.org/
Title: Default Aegisub file
ScriptType: v4.00+
WrapStyle: 0
ScaledBorderAndShadow: yes
YCbCr Matrix: TV.709
PlayResX: 1920
PlayResY: 1080

[Aegisub Project Garbage]
Last Style Storage: Default
Audio File: 鲤鱼发呆-压字幕源.mp4
Video File: 鲤鱼发呆-压字幕源.mp4
Video AR Mode: 4
Video AR Value: 1.777778
Video Zoom Percent: 0.500000
Video Position: 889

[V4+ Styles]
Format: Name, Fontname, Fontsize, PrimaryColour, SecondaryColour, OutlineColour, BackColour, Bold, Italic, Underline, StrikeOut, ScaleX, ScaleY, Spacing, Angle, BorderStyle, Outline, Shadow, Alignment, MarginL, MarginR, MarginV, Encoding
Style: 全局阴影-furigana,ipid-ZhuZiCN-TsukuJP-E,46,&H00FFFFFF,&H00FFFFFF,&H00FFFFFF,&H96727272,0,0,0,0,100,100,0,0,1,6,4,2,10,10,70,1
Style: 水-渡边曜-朱夏-furigana,ipid-ZhuZiCN-TsukuJP-E,46,&H00D29200,&H00C69825,&H00FFFFFF,&H50FFC33B,0,0,0,0,100,100,0,0,1,6,4,2,10,10,70,1
Style: 虹-岚珠-菜宝-furigana,ipid-ZhuZiCN-TsukuJP-E,46,&H006169FF,&H00737AFE,&H00FFFFFF,&H00B8B7EE,0,0,0,0,100,100,0,0,1,6,4,2,10,10,70,1
Style: 星-可可-鲤鱼-furigana,ipid-ZhuZiCN-TsukuJP-E,46,&H00A0AC00,&H00A1AC08,&H00FFFFFF,&H50EBF793,0,0,0,0,100,100,0,0,1,6,4,2,10,10,70,1
Style: Default-furigana,方正FW筑紫A圆 简 E,46,&H00555652,&H00555652,&H00FFFFFF,&H206A6660,0,0,0,0,100,100,0,0,1,4,3,2,10,10,70,1
Style: Default,方正FW筑紫A圆 简 E,92,&H00555652,&H00555652,&H00FFFFFF,&H206A6660,0,0,0,0,100,100,0,0,1,8,6,2,10,10,70,1
Style: 星-可可-鲤鱼,ipid-ZhuZiCN-TsukuJP-E,92,&H00A0AC00,&H00A1AC08,&H00FFFFFF,&H50EBF793,0,0,0,0,100,100,0,0,1,11,8,2,10,10,70,1
Style: 虹-岚珠-菜宝,ipid-ZhuZiCN-TsukuJP-E,92,&H006169FF,&H00737AFE,&H00FFFFFF,&H00B8B7EE,0,0,0,0,100,100,0,0,1,11,8,2,10,10,70,1
Style: 水-渡边曜-朱夏,ipid-ZhuZiCN-TsukuJP-E,92,&H00D29200,&H00C69825,&H00FFFFFF,&H50FFC33B,0,0,0,0,100,100,0,0,1,11,8,2,10,10,70,1
Style: 全局阴影,ipid-ZhuZiCN-TsukuJP-E,92,&H00FFFFFF,&H00FFFFFF,&H00FFFFFF,&H96727272,0,0,0,0,100,100,0,0,1,12,8,2,10,10,70,1

[Events]
Format: Layer, Start, End, Style, Name, MarginL, MarginR, MarginV, Effect, Text
Comment: 0,0:00:00.00,0:00:00.01,Default,,0,0,0,code once, --[[ 颜色参数：第二层描边大小、不透明度 ]] EB_WIDTH = 3 ; EB_OPACITY = 1 ; EB_BLEND_WHITE = 0.8 ; EB_BOARD_DELTA = -6 ; GLOBAL_SHADOW_STYLE = '全局阴影'
Comment: 0,0:00:00.00,0:00:00.00,Default,,0,0,0,code once,local function errMsg(text, okBtn) _G.aegisub.dialog.display({ { class = 'label', label = text, x = 0, y = 0 } }, { okBtn }) _G.error(text) end if _G.aegisub.frame_from_ms(0) == nil then errMsg('【错误】\n\n本卡拉 OK 模板必须在打开视频之后才能运行。\n请打开一个视频后再运行本卡拉 OK 模板。\n如果没有视频，请点击「视频」→「使用空白视频」。\n', '好的，我现在就去打开视频') end local function trim(to_trim) --[[ 这里必须用一个中间变量，不然会返回多个参数 ]] local result = _G.string.gsub(to_trim, '^%s+', ''):gsub('%s+$', '') return result end local function getSpecificVar(targetName) local level = 1 while _G.debug.getinfo(level) ~= nil do local i = 1 while true do local name, value = _G.debug.getlocal(level, i) if name == targetName then return value elseif name == nil then break end i = i + 1 end level = level + 1 end return nil end --[[ 通过 subs 对象获取当前字幕内容（但是获取不到 Format:，不过 accupos（libass）兼容） ]] local function getSubtitleContent(currSubs) local assFile = {} local hasSection = {} local playResX = 0 local playResY = 0 for i = 1, #currSubs do local sub = currSubs[i] if sub.key == 'PlayResX' then playResX = _G.tonumber(sub.value) elseif sub.key == 'PlayResY' then playResY = _G.tonumber(sub.value) end local section = sub.section if not hasSection[section] then _G.table.insert(assFile, '\n' .. section) hasSection[section] = true end local toInsert = sub.raw --[[ 把符合 kara-templater 匹配模板条件的 Comment 替换成 Dialogue ]] if sub.class == 'dialogue' and sub.comment == true and sub.effect:match('[Kk]araoke') then toInsert = _G.string.gsub(toInsert, 'Comment: ', 'Dialogue: ', 1) end if sub.class == 'dialogue' then if trim(sub.text) == '' then toInsert = '' end if _G.aegisub.frame_from_ms(sub.start_time) >= _G.aegisub.frame_from_ms(sub.end_time) then toInsert = '' end end _G.table.insert(assFile, trim(toInsert)) end if playResX == 0 or playResY == 0 then playResX, playResY = _G.aegisub.video_size() end return _G.table.concat(assFile, '\n'), playResX, playResY end local function getPosWithAccupos(assText, playResX, playResY) local ffi = _G.require('ffi') ffi.cdef([[ typedef struct { double pos_x, pos_y; const char *raw; int32_t width, height; int32_t is_positioned; } Accupos_Dialogue; typedef struct Accupos_LibassPrivate Accupos_LibassPrivate; typedef struct { Accupos_LibassPrivate *libass; Accupos_Dialogue *dialogues; int32_t n_dialogues; } Accupos_Library; Accupos_Library *accupos_init( int32_t width, int32_t height, const char *ass_data, int32_t ass_data_len ); void accupos_done(Accupos_Library *lib); ]]) local dll = ffi.load(_G.jit.arch == 'x64' and 'accupos64' or 'accupos32') local accupos = dll.accupos_init(playResX, playResY, assText, #assText) if accupos == nil then errMsg('\n代码出错：accupos_init 返回了 NULL，这表明初始化出错。', '好的，我会给开发者报告错误') end local result = {} local dialogueNum = accupos.n_dialogues for i = 1, dialogueNum do local origD = accupos.dialogues[i - 1] if origD.raw == nil then errMsg(_G.string.format('【代码出错】\n\naccupos->dialogues[%d].raw 为 NULL，这表明 accupos 内部出错了。\n', i - 1), '好的，我会给开发者报告错误') end local d = { raw = ffi.string(origD.raw), posX = origD.pos_x, posY = origD.pos_y, width = origD.width, height = origD.height, isPositioned = (origD.is_positioned ~= 0), } if d.width > 0 and d.height > 0 then _G.table.insert(result, d) end end dll.accupos_done(accupos) return result end local function startsWith(str, pattern) return str:sub(1, #pattern) == pattern end local currSubs = getSpecificVar('subs') local assText, playResX, playResY = getSubtitleContent(currSubs) local positions = getPosWithAccupos(assText, playResX, playResY) local globalCounter = 1 local lastIndex = -1 function findMatchingLine(index) --[[ 这里必须用 text_stripped 做判断，因为 libass 也不会输出纯注释行（例：只有一个 {?} 的行） ]] if trim(orgline.text_stripped) == '' then return '' end if _G.aegisub.frame_from_ms(orgline.start_time) >= _G.aegisub.frame_from_ms(orgline.end_time) then return '' end if lastIndex ~= index then local lineRaw = trim(orgline.raw) if startsWith(lineRaw, 'Comment: ') then lineRaw = _G.string.gsub(lineRaw, 'Comment: ', 'Dialogue: ', 1) end while positions[globalCounter].raw ~= lineRaw do globalCounter = globalCounter + 1 if globalCounter > #positions then _G.error(_G.string.format('【代码出错】\n\n重建的字幕文件与实际字幕不匹配。\n当前行为 <%s>，\n在第 %d 行后找不到该行。\n', orgline.raw, lastIndex)) end end lastIndex = index end return '' end function getPos() local p = positions[globalCounter] if p.isPositioned then return '' end local posX = _G.string.format('%.2f', p.posX):gsub('%.?0+$', '') local posY = _G.string.format('%.2f', p.posY):gsub('%.?0+$', '') return _G.string.format([[\pos(%d,%d)]], posX, posY) end function getLine() return orgline.text end function resetMargin() line.margin_l = 0 line.margin_r = 0 line.margin_t = 0 line.margin_b = 0 return '' end function matchShadowToCurrentStyle() local st = getSpecificVar('styles') if GLOBAL_SHADOW_STYLE == nil then errMsg('【错误】\n\nGLOBAL_SHADOW_STYLE 变量未设置，可能您复制特效代码的时候没有复制完全。\n', '好，我检查一下特效行复制对了没有') end if st[GLOBAL_SHADOW_STYLE] == nil then errMsg(_G.string.format('【错误】\n\n你没有把「%s」样式导入进来。\n请您现在打开「样式管理器」，重新导入一遍样式，注意「%s」样式一定要导入。\n', GLOBAL_SHADOW_STYLE, GLOBAL_SHADOW_STYLE), '好，我这就去导入') end --[[ TODO: 解析 \bord 并兼容 ]] local an = line.styleref.align ~= st[GLOBAL_SHADOW_STYLE].align and '\\an' .. line.styleref.align or '' local fs = line.styleref.fontsize ~= st[GLOBAL_SHADOW_STYLE].fontsize and '\\fs' .. line.styleref.fontsize or '' local fn = line.styleref.fontname ~= st[GLOBAL_SHADOW_STYLE].fontname and '\\fn' .. line.styleref.fontname or '' local fscx = line.styleref.scale_x ~= st[GLOBAL_SHADOW_STYLE].scale_x and '\\fscx' .. line.styleref.scale_x or '' local fscy = line.styleref.scale_y ~= st[GLOBAL_SHADOW_STYLE].scale_y and '\\fscy' .. line.styleref.scale_y or '' local fsp = line.styleref.spacing ~= st[GLOBAL_SHADOW_STYLE].spacing and '\\fsp' .. line.styleref.spacing or '' local b = line.styleref.bold ~= st[GLOBAL_SHADOW_STYLE].bold and '\\b1' or '' local i = line.styleref.italic ~= st[GLOBAL_SHADOW_STYLE].italic and '\\i1' or '' local u = line.styleref.underline ~= st[GLOBAL_SHADOW_STYLE].underline and '\\u1' or '' return an .. fs .. fn .. fscx .. fscy .. fsp .. b .. i .. u end
Comment: 0,0:00:00.00,0:00:00.00,Default,,0,0,0,template line all notext,!findMatchingLine(line.i)!{!getPos()!!matchShadowToCurrentStyle()!\bord!line.styleref.outline + EB_WIDTH + EB_BOARD_DELTA!\shad!line.styleref.outline + EB_WIDTH - 1!\1a&HFF&\3a&HFF&}!getLine()!!restyle(GLOBAL_SHADOW_STYLE)!!resetMargin()!!relayer(0)!
Comment: 0,0:00:00.00,0:00:00.00,Default,,0,0,0,template line all notext,!findMatchingLine(line.i)!{!getPos()!\bord!line.styleref.outline + EB_WIDTH!\shad!line.styleref.shadow - EB_WIDTH!\3c!_G.interpolate_color(EB_BLEND_WHITE,'&HFFFFFF&',line.styleref.color2)!\3a&H!_G.string.format('%02X',(1-EB_OPACITY)*255)!&\1a&HFF&\4a&H00&}!getLine()!!resetMargin()!!relayer(1)!
Comment: 0,0:00:00.00,0:00:00.00,Default,,0,0,0,template line all notext,!findMatchingLine(line.i)!{!getPos()!\shad0}!getLine()!!resetMargin()!!relayer(2)!
Comment: 0,0:00:00.00,0:00:02.50,水-渡边曜-朱夏,,0,0,0,karaoke,就请大家收集喜欢的学园偶像卡片
Comment: 0,0:00:02.50,0:00:04.49,水-渡边曜-朱夏,,0,0,0,karaoke,把相册的每一页填满吧
Comment: 0,0:00:06.08,0:00:07.17,水-渡边曜-朱夏,,0,0,0,karaoke,好…
Comment: 0,0:00:07.17,0:00:08.78,水-渡边曜-朱夏,,0,0,0,karaoke,然后然后 鲤酱？
Comment: 0,0:00:08.78,0:00:10.07,星-可可-鲤鱼,,0,0,0,karaoke,啊 刚刚…
Comment: 0,0:00:10.07,0:00:16.79,星-可可-鲤鱼,,0,0,0,karaoke,刚刚那边的大屏幕上突然有东西显示出来
Comment: 0,0:00:16.79,0:00:19.77,星-可可-鲤鱼,,0,0,0,karaoke,注意力就有点被吸引过去了
Comment: 0,0:00:19.56,0:00:23.18,水-渡边曜-朱夏,,0,0,0,karaoke,屏幕上突然显示个大的东西 当然会去看啦
Comment: 0,0:00:23.18,0:00:25.35,水-渡边曜-朱夏,,0,0,0,karaoke,屏幕啊 懂不懂得看场合啊？
Comment: 0,0:00:26.32,0:00:28.11,虹-岚珠-菜宝,,0,0,0,karaoke,前辈的温柔安慰
Comment: 0,0:00:28.81,0:00:31.10,星-可可-鲤鱼,,0,0,0,karaoke,接下来 接下来…
Dialogue: 0,0:00:00.00,0:00:02.50,全局阴影,,0,0,0,fx,{\pos(960,1010)\bord8\shad13\1a&HFF&\3a&HFF&}就请大家收集喜欢的学园偶像卡片
Dialogue: 1,0:00:00.00,0:00:02.50,水-渡边曜-朱夏,,0,0,0,fx,{\pos(960,1010)\bord14\shad5\3c&HD1AC50&\3a&H00&\1a&HFF&\4a&H00&}就请大家收集喜欢的学园偶像卡片
Dialogue: 2,0:00:00.00,0:00:02.50,水-渡边曜-朱夏,,0,0,0,fx,{\pos(960,1010)\shad0}就请大家收集喜欢的学园偶像卡片
Dialogue: 0,0:00:02.50,0:00:04.49,全局阴影,,0,0,0,fx,{\pos(960,1010)\bord8\shad13\1a&HFF&\3a&HFF&}把相册的每一页填满吧
Dialogue: 1,0:00:02.50,0:00:04.49,水-渡边曜-朱夏,,0,0,0,fx,{\pos(960,1010)\bord14\shad5\3c&HD1AC50&\3a&H00&\1a&HFF&\4a&H00&}把相册的每一页填满吧
Dialogue: 2,0:00:02.50,0:00:04.49,水-渡边曜-朱夏,,0,0,0,fx,{\pos(960,1010)\shad0}把相册的每一页填满吧
Dialogue: 0,0:00:06.08,0:00:07.17,全局阴影,,0,0,0,fx,{\pos(960,1010)\bord8\shad13\1a&HFF&\3a&HFF&}好…
Dialogue: 1,0:00:06.08,0:00:07.17,水-渡边曜-朱夏,,0,0,0,fx,{\pos(960,1010)\bord14\shad5\3c&HD1AC50&\3a&H00&\1a&HFF&\4a&H00&}好…
Dialogue: 2,0:00:06.08,0:00:07.17,水-渡边曜-朱夏,,0,0,0,fx,{\pos(960,1010)\shad0}好…
Dialogue: 0,0:00:07.17,0:00:08.78,全局阴影,,0,0,0,fx,{\pos(960,1010)\bord8\shad13\1a&HFF&\3a&HFF&}然后然后 鲤酱？
Dialogue: 1,0:00:07.17,0:00:08.78,水-渡边曜-朱夏,,0,0,0,fx,{\pos(960,1010)\bord14\shad5\3c&HD1AC50&\3a&H00&\1a&HFF&\4a&H00&}然后然后 鲤酱？
Dialogue: 2,0:00:07.17,0:00:08.78,水-渡边曜-朱夏,,0,0,0,fx,{\pos(960,1010)\shad0}然后然后 鲤酱？
Dialogue: 0,0:00:08.78,0:00:10.07,全局阴影,,0,0,0,fx,{\pos(960,1010)\bord8\shad13\1a&HFF&\3a&HFF&}啊 刚刚…
Dialogue: 1,0:00:08.78,0:00:10.07,星-可可-鲤鱼,,0,0,0,fx,{\pos(960,1010)\bord14\shad5\3c&HB3BC39&\3a&H00&\1a&HFF&\4a&H00&}啊 刚刚…
Dialogue: 2,0:00:08.78,0:00:10.07,星-可可-鲤鱼,,0,0,0,fx,{\pos(960,1010)\shad0}啊 刚刚…
Dialogue: 0,0:00:10.07,0:00:16.79,全局阴影,,0,0,0,fx,{\pos(960,1010)\bord8\shad13\1a&HFF&\3a&HFF&}刚刚那边的大屏幕上突然有东西显示出来
Dialogue: 1,0:00:10.07,0:00:16.79,星-可可-鲤鱼,,0,0,0,fx,{\pos(960,1010)\bord14\shad5\3c&HB3BC39&\3a&H00&\1a&HFF&\4a&H00&}刚刚那边的大屏幕上突然有东西显示出来
Dialogue: 2,0:00:10.07,0:00:16.79,星-可可-鲤鱼,,0,0,0,fx,{\pos(960,1010)\shad0}刚刚那边的大屏幕上突然有东西显示出来
Dialogue: 0,0:00:16.79,0:00:19.77,全局阴影,,0,0,0,fx,{\pos(960,1010)\bord8\shad13\1a&HFF&\3a&HFF&}注意力就有点被吸引过去了
Dialogue: 1,0:00:16.79,0:00:19.77,星-可可-鲤鱼,,0,0,0,fx,{\pos(960,1010)\bord14\shad5\3c&HB3BC39&\3a&H00&\1a&HFF&\4a&H00&}注意力就有点被吸引过去了
Dialogue: 2,0:00:16.79,0:00:19.77,星-可可-鲤鱼,,0,0,0,fx,{\pos(960,1010)\shad0}注意力就有点被吸引过去了
Dialogue: 0,0:00:19.56,0:00:23.18,全局阴影,,0,0,0,fx,{\pos(960,896)\bord8\shad13\1a&HFF&\3a&HFF&}屏幕上突然显示个大的东西 当然会去看啦
Dialogue: 1,0:00:19.56,0:00:23.18,水-渡边曜-朱夏,,0,0,0,fx,{\pos(960,896)\bord14\shad5\3c&HD1AC50&\3a&H00&\1a&HFF&\4a&H00&}屏幕上突然显示个大的东西 当然会去看啦
Dialogue: 2,0:00:19.56,0:00:23.18,水-渡边曜-朱夏,,0,0,0,fx,{\pos(960,896)\shad0}屏幕上突然显示个大的东西 当然会去看啦
Dialogue: 0,0:00:23.18,0:00:25.35,全局阴影,,0,0,0,fx,{\pos(960,1010)\bord8\shad13\1a&HFF&\3a&HFF&}屏幕啊 懂不懂得看场合啊？
Dialogue: 1,0:00:23.18,0:00:25.35,水-渡边曜-朱夏,,0,0,0,fx,{\pos(960,1010)\bord14\shad5\3c&HD1AC50&\3a&H00&\1a&HFF&\4a&H00&}屏幕啊 懂不懂得看场合啊？
Dialogue: 2,0:00:23.18,0:00:25.35,水-渡边曜-朱夏,,0,0,0,fx,{\pos(960,1010)\shad0}屏幕啊 懂不懂得看场合啊？
Dialogue: 0,0:00:26.32,0:00:28.11,全局阴影,,0,0,0,fx,{\pos(960,1010)\bord8\shad13\1a&HFF&\3a&HFF&}前辈的温柔安慰
Dialogue: 1,0:00:26.32,0:00:28.11,虹-岚珠-菜宝,,0,0,0,fx,{\pos(960,1010)\bord14\shad5\3c&H8F94FE&\3a&H00&\1a&HFF&\4a&H00&}前辈的温柔安慰
Dialogue: 2,0:00:26.32,0:00:28.11,虹-岚珠-菜宝,,0,0,0,fx,{\pos(960,1010)\shad0}前辈的温柔安慰
Dialogue: 0,0:00:28.81,0:00:31.10,全局阴影,,0,0,0,fx,{\pos(960,1010)\bord8\shad13\1a&HFF&\3a&HFF&}接下来 接下来…
Dialogue: 1,0:00:28.81,0:00:31.10,星-可可-鲤鱼,,0,0,0,fx,{\pos(960,1010)\bord14\shad5\3c&HB3BC39&\3a&H00&\1a&HFF&\4a&H00&}接下来 接下来…
Dialogue: 2,0:00:28.81,0:00:31.10,星-可可-鲤鱼,,0,0,0,fx,{\pos(960,1010)\shad0}接下来 接下来…
